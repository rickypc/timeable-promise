# Copyright (c) 2018-2025 Richard Huang <rickypc@users.noreply.github.com>
# Description: Validate composite GHA.
# File: action.yml
# License: AGPL-3.0-or-later

description: Setup Node.js, install dependencies, run a validation command.
name: Setup
inputs:
  cache-dependency-path:
    default: '**/package.json'
    description: Path to dependency file for caching
    required: false
  command:
    description: Validation command to run after install
    required: true
  node-version:
    description: Node.js version to use
    required: true
runs:
  using: composite
  steps:
    - name: Setup Node
      uses: actions/setup-node@v4
      with:
        cache: yarn
        cache-dependency-path: ${{inputs.cache-dependency-path}}
        node-version: ${{inputs.node-version}}
    - name: Install
      run: |
        echo "::group::\033[34mInstall Dependencies\033[0m"
        yarn
        echo "::endgroup::"
      shell: bash
    - name: Validate
      run: |
        echo "::group::\033[1;34mRunning Validation\033[0m"
        OUTPUT=$(mktemp)
        set +e
        ${{inputs.command}} 2>&1 | tee "$OUTPUT"
        EXIT_CODE=${PIPESTATUS[0]}
        set -e
        if [ $EXIT_CODE -ne 0 ]; then
          echo "### âŒ Command failed: \`${{inputs.command}}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          cat "$OUTPUT" >> $GITHUB_STEP_SUMMARY
          rm -f "$OUTPUT"
          echo "::endgroup::"
          exit $EXIT_CODE
        else
          rm -f "$OUTPUT"
          echo "::endgroup::"
        fi
      shell: bash
